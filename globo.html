<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Consysencia | Plataforma VOD</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
    
    :root {
      --bg: #0b0b0f; --text: #fff; --accent: #ff3d00;
      --panelBg: rgba(6,6,8,0.95); --radius: 12px;
    }

    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; overflow: hidden; }

    #app { display: flex; height: 100vh; width: 100vw; }
    
    #sidebar { width: 260px; height: 100vh; background: var(--panelBg); border-right: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; z-index: 100; transition: 0.3s; position: relative; }
    .brand { padding: 20px; font-weight: 900; font-size: 20px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; gap: 10px; }
    .brand span { color: var(--accent); }
    
    .nav-back { margin: 15px; padding: 12px; border-radius: var(--radius); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-weight: bold; color: var(--accent); border: 1px solid var(--accent); transition: 0.2s; }
    .nav-back:hover { background: var(--accent); color: #000; }

    #main { flex: 1; display: flex; flex-direction: column; height: 100vh; position: relative; }
    #topbar { height: 70px; display: flex; align-items: center; padding: 0 20px; gap: 15px; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); }
    #hamb { background: rgba(255,255,255,0.1); border: none; color: white; width: 40px; height: 40px; border-radius: 8px; cursor: pointer; display: none; }
    #viewTitle { font-weight: 900; font-size: 20px; flex: 1; text-transform: uppercase; letter-spacing: 1px; }

    #catalogRoot { flex: 1; overflow-y: auto; padding: 10px 20px 40px; -webkit-overflow-scrolling: touch; }
    .row { margin-bottom: 30px; }
    .rowTitle { font-size: 1.2rem; font-weight: 900; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
    .rowTitle::before { content:''; width:5px; height:18px; background: var(--accent); border-radius: 4px; }
    
    .rail { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 15px; scroll-snap-type: x mandatory; }
    .rail::-webkit-scrollbar { display: none; }

    .card { flex: 0 0 auto; width: 140px; height: 210px; border-radius: 10px; background: #111; overflow: hidden; position: relative; scroll-snap-align: start; cursor: pointer; border: 1px solid rgba(255,255,255,0.05); transition: 0.3s; }
    .card:hover { transform: translateY(-5px) scale(1.05); border-color: var(--accent); box-shadow: 0 10px 20px rgba(0,0,0,0.5); z-index: 2; }
    .card img { width: 100%; height: 100%; object-fit: cover; background: #222; }
    .cardName { position: absolute; bottom: 0; width: 100%; padding: 25px 10px 10px; background: linear-gradient(transparent, rgba(0,0,0,0.95)); font-size: 12px; text-align: center; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-shadow: 0 2px 4px black; }

    #detailsView { display: none; position: fixed; inset: 0; background: var(--bg); z-index: 5000; overflow-y: auto; }
    .det-backdrop { width: 100%; height: 45vh; background-size: cover; background-position: top; position: relative; }
    .det-backdrop::after { content: ''; position: absolute; inset: 0; background: linear-gradient(to bottom, transparent, var(--bg)); }
    .det-back-btn { position: absolute; top: 20px; left: 20px; z-index: 10; background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 8px; color: white; border: 1px solid rgba(255,255,255,0.3); cursor: pointer; font-weight: bold; backdrop-filter: blur(5px); transition: 0.2s; }
    .det-back-btn:hover { background: var(--accent); color: #000; border-color: var(--accent); }
    .det-content { padding: 20px; position: relative; top: -60px; z-index: 5; max-width: 1000px; margin: 0 auto; }
    .det-title { font-size: 2.5rem; font-weight: 900; margin-bottom: 20px; text-shadow: 0 2px 10px black; }
    
    .det-play-btn { background: var(--accent); color: #fff; padding: 15px 35px; font-weight: 900; border-radius: 8px; border: none; font-size: 1.1rem; cursor: pointer; display: inline-flex; align-items: center; gap: 10px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.4); transition: 0.2s; }
    .det-play-btn:hover { transform: scale(1.05); }
    
    #seasonSelect { background: #111; color: white; border: 1px solid rgba(255,255,255,0.2); padding: 12px 20px; border-radius: 8px; font-size: 1rem; margin-bottom: 20px; outline: none; font-weight: bold; width: 100%; max-width: 300px; display: none; }
    .ep-item { display: flex; align-items: center; gap: 15px; padding: 15px; background: rgba(255,255,255,0.03); margin-bottom: 10px; cursor: pointer; border-radius: 10px; border: 1px solid rgba(255,255,255,0.05); transition: 0.2s; }
    .ep-item:hover { background: rgba(255,255,255,0.08); border-color: var(--accent); transform: translateX(5px); }
    .ep-img { width: 45px; height: 45px; background: rgba(0,0,0,0.5); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--accent); border: 2px solid var(--accent); }
    .ep-title { font-weight: bold; font-size: 1rem; }

    #loader, #detLoader { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; flex-direction: column; z-index: 9999; color: var(--accent); font-weight: bold; gap: 10px; }
    #detLoader { background: rgba(0,0,0,0.85); display: none; }
    .spinner { border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    #playerRoot { display: none; position: fixed; inset: 0; background: #000; z-index: 10000; flex-direction: column; }
    #pControls { position: absolute; top: 0; width: 100%; padding: 20px; display: flex; align-items: center; gap: 15px; background: linear-gradient(rgba(0,0,0,0.9), transparent); z-index: 10; }
    #btnBackPlayer { background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; backdrop-filter: blur(5px); }
    #btnBackPlayer:hover { background: var(--accent); color: #000; }
    #video { width: 100%; height: 100%; object-fit: contain; }

    @media (max-width: 900px) {
      #sidebar { position: absolute; left: -100%; }
      #sidebar.open { left: 0; }
      #hamb { display: block; }
    }
  </style>
</head>
<body>

<div id="loader"><div class="spinner"></div><div id="lText">A preparar o Catálogo...</div></div>
<div id="detLoader"><div class="spinner"></div><div>A aceder à base de dados...</div></div>

<div id="app">
    <aside id="sidebar">
        <div class="brand"><span>●</span> <span id="brandName">Plataforma</span></div>
        <div class="nav-back" onclick="goBackToHub()"><i class="fa-solid fa-house"></i> Voltar ao Hub</div>
    </aside>

    <main id="main">
        <div id="topbar">
            <button id="hamb" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
            <div id="viewTitle">Catálogo</div>
        </div>
        <div id="catalogRoot"></div>
    </main>
</div>

<div id="detailsView">
    <div class="det-backdrop" id="detBackdrop">
        <button class="det-back-btn" onclick="closeDetails()"><i class="fa-solid fa-arrow-left"></i> Voltar à Lista</button>
    </div>
    <div class="det-content">
        <h1 class="det-title" id="detTitle">Nome do Filme/Série</h1>
        <button class="det-play-btn" id="detPlayBtn" style="display:none;"><i class="fa-solid fa-play"></i> Assistir Filme</button>
        <select id="seasonSelect"></select>
        <div id="episodeList"></div>
    </div>
</div>

<div id="playerRoot">
    <div id="pControls">
        <button id="btnBackPlayer" onclick="closePlayer()"><i class="fa-solid fa-arrow-left"></i> Voltar</button>
        <div id="pTitle" style="font-weight: 900; text-shadow: 0 2px 4px black; font-size: 1.2rem;"></div>
    </div>
    <video id="video" controls autoplay playsinline></video>
</div>

<script>
    // =========================================================
    // CONFIGURAÇÃO GLOBOPLAY
    // =========================================================
    const PLATFORM_KEY = 'globo';   
    const PLATFORM_NAME = 'GloboPlay';  
    const PLATFORM_COLOR = '#ff3d00'; 
    
    document.documentElement.style.setProperty('--accent', PLATFORM_COLOR);
    document.getElementById('brandName').innerText = PLATFORM_NAME;
    document.getElementById('viewTitle').innerText = 'Catálogo ' + PLATFORM_NAME;
    document.title = 'Consysencia | ' + PLATFORM_NAME;

    const urlParams = new URLSearchParams(window.location.search);
    const u = urlParams.get('u');
    const p = urlParams.get('p');
    if(!u || !p) { window.location.href = 'index.html'; }

    const API = 'https://api.consysencia.com/catalog';
    const PROXY_BASE = 'https://api.consysencia.com/proxy';

    let currentSeriesData = null;
    let savedScrollPos = 0;
    let hls;

    async function bootPlatform() {
        const h = { 'Authorization': 'Basic ' + btoa(u + ':' + p) };
        const root = document.getElementById('catalogRoot');
        
        try {
            const [vcat, scat] = await Promise.all([
                fetch(`${API}?action=get_vod_categories`, {headers:h}).then(r=>r.json()).catch(()=>[]),
                fetch(`${API}?action=get_series_categories`, {headers:h}).then(r=>r.json()).catch(()=>[])
            ]);

            const targetVod = (vcat || []).filter(c => c.category_name.toLowerCase().includes(PLATFORM_KEY.toLowerCase()));
            const targetSeries = (scat || []).filter(c => c.category_name.toLowerCase().includes(PLATFORM_KEY.toLowerCase()));

            if (targetVod.length === 0 && targetSeries.length === 0) {
                root.innerHTML = '<h3 style="color:#aaa; text-align:center; margin-top:50px;">Nenhum conteúdo encontrado para esta plataforma.</h3>';
                document.getElementById('loader').style.display = 'none';
                return;
            }

            for (const cat of targetVod) {
                const items = await fetch(`${API}?action=get_vod_streams&category_id=${cat.category_id}`, {headers:h}).then(r=>r.json()).catch(()=>[]);
                renderRow(cat.category_name, items, 'movie', root);
            }

            for (const cat of targetSeries) {
                const items = await fetch(`${API}?action=get_series&category_id=${cat.category_id}`, {headers:h}).then(r=>r.json()).catch(()=>[]);
                renderRow(cat.category_name, items, 'series', root);
            }

            document.getElementById('loader').style.display = 'none';

        } catch(e) {
            alert("Erro de ligação.");
            goBackToHub();
        }
    }

    function renderRow(title, items, type, container) {
        if (!items || items.length === 0) return;
        
        const row = document.createElement('div');
        row.className = 'row';
        row.innerHTML = `
            <div class="rowTitle">${title}</div>
            <div class="rail">
                ${items.map(i => {
                    const img = i.stream_icon || i.cover || '';
                    const safeName = (i.name || '').replace(/'/g, "\\'").replace(/"/g, "&quot;");
                    const id = type === 'movie' ? i.stream_id : i.series_id;
                    const ext = i.container_extension || 'mp4';
                    
                    return `
                    <div class="card" onclick="openDetails('${id}', '${type}', '${ext}', '${safeName}', '${img}')">
                        <img src="${img}" loading="lazy" onerror="this.style.display='none'">
                        <div class="cardName">${i.name}</div>
                    </div>`;
                }).join('')}
            </div>
        `;
        container.appendChild(row);
    }

    async function openDetails(id, type, ext, name, cover) {
        savedScrollPos = document.getElementById('catalogRoot').scrollTop;
        document.getElementById('app').style.display = 'none';
        
        const detailsView = document.getElementById('detailsView');
        detailsView.style.display = 'block';
        detailsView.scrollTop = 0;

        document.getElementById('detTitle').innerText = name;
        document.getElementById('detBackdrop').style.backgroundImage = `url('${cover}')`;
        
        const playBtn = document.getElementById('detPlayBtn');
        const seasonSelect = document.getElementById('seasonSelect');
        const epList = document.getElementById('episodeList');

        epList.innerHTML = '';
        currentSeriesData = null;

        if (type === 'movie') {
            playBtn.style.display = 'inline-flex';
            seasonSelect.style.display = 'none';
            playBtn.onclick = () => playStream(id, 'movie', ext, name);
        } else {
            playBtn.style.display = 'none';
            document.getElementById('detLoader').style.display = 'flex';
            
            try {
                const res = await fetch(`${API}?action=get_series_info&series_id=${id}`, { headers: { 'Authorization': 'Basic ' + btoa(u + ':' + p) } });
                const data = await res.json();
                document.getElementById('detLoader').style.display = 'none';
                
                currentSeriesData = data.episodes;
                const seasonKeys = Object.keys(currentSeriesData);
                
                if (seasonKeys.length > 0) {
                    seasonSelect.style.display = 'block';
                    seasonSelect.innerHTML = seasonKeys.map(s => `<option value="${s}">Temporada ${s}</option>`).join('');
                    seasonSelect.onchange = (e) => renderEpisodes(e.target.value);
                    renderEpisodes(seasonKeys[0]);
                } else {
                    epList.innerHTML = '<p>Nenhum episódio no servidor.</p>';
                }
            } catch(e) {
                document.getElementById('detLoader').style.display = 'none';
                epList.innerHTML = '<p>Falha ao carregar a série.</p>';
            }
        }
    }

    function renderEpisodes(seasonNumber) {
        const episodes = currentSeriesData[seasonNumber] || [];
        const epList = document.getElementById('episodeList');
        
        epList.innerHTML = episodes.map(ep => {
            const epExt = ep.container_extension || 'mp4';
            const safeEpTitle = ep.title ? ep.title.replace(/'/g, "\\'") : `Episódio ${ep.episode_num}`;
            const displayName = `E${ep.episode_num} - ${safeEpTitle}`;
            
            return `
            <div class="ep-item" onclick="playStream('${ep.id}', 'series', '${epExt}', 'T${seasonNumber}: ${displayName}')">
                <div class="ep-img"><i class="fa-solid fa-play"></i></div>
                <div class="ep-title">${displayName}</div>
            </div>`;
        }).join('');
    }

    function closeDetails() {
        document.getElementById('detailsView').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
        document.getElementById('catalogRoot').scrollTop = savedScrollPos;
    }

    function playStream(id, type, ext, name) {
        document.getElementById('pTitle').innerText = name;
        const secureUrl = `${PROXY_BASE}/${type}/${u}/${p}/${id}.${ext}`;

        document.getElementById('detailsView').style.display = 'none';
        document.getElementById('app').style.display = 'none';
        document.getElementById('playerRoot').style.display = 'flex';
        
        const video = document.getElementById('video');

        if(hls) { hls.destroy(); hls = null; }
        
        video.src = secureUrl;
        video.play().catch(()=>{});
    }

    function closePlayer() {
        const video = document.getElementById('video');
        video.pause(); video.src = "";
        
        document.getElementById('playerRoot').style.display = 'none';
        document.getElementById('detailsView').style.display = 'block';
    }

    function goBackToHub() { window.location.href = 'index.html'; }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

    bootPlatform();
</script>
</body>
</html>
