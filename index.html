<script>
  const SUPABASE_URL = 'https://zlvxbgxdrmllzmbmhitm.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpsdnhiZ3hkcm1sbHptYm1oaXRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyOTgzMzQsImV4cCI6MjA4Nzg3NDMzNH0.N-zyV1YlxUba7E7mWK5xqmYeCr-KeBj9yiuiOOw62xs';

  const clienteSupabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  function setErro(msg){
    const errorMsg = document.getElementById('error-msg');
    if (!errorMsg) return;
    errorMsg.innerText = msg;
    errorMsg.style.display = 'block';
  }

  function setBtnLoading(isLoading){
    const btn = document.getElementById('btn-login');
    if (!btn) return;
    if (isLoading){
      btn.innerHTML = "Aguarde...";
      btn.disabled = true;
    } else {
      btn.innerHTML = `<img src="https://cdn-icons-png.flaticon.com/512/2991/2991148.png" alt="Google" width="20" style="margin-right: 6px;"> Entrar com Google`;
      btn.disabled = false;
    }
  }

  async function checarSessao() {
    try {
      // garante que o SDK teve chance de processar callback/fragment
      const { data: { session }, error } = await clienteSupabase.auth.getSession();
      if (error) throw error;

      if (session?.user) {
        mostrarPlayer(session.user);
        buscarAlertas(session.user.id);
      }
    } catch (err) {
      console.error("Erro na sessão:", err);
    }
  }

  async function loginComGoogle() {
    const errorMsg = document.getElementById('error-msg');
    if (errorMsg) errorMsg.style.display = 'none';
    setBtnLoading(true);

    try {
      const redirectTo = window.location.href.split('#')[0]; // mais robusto

      const { error } = await clienteSupabase.auth.signInWithOAuth({
        provider: 'google',
        options: { redirectTo }
      });

      if (error) throw error;
      // daqui pra frente o browser vai redirecionar
    } catch (err) {
      console.error("Falha no login:", err);
      setErro("Erro no Google: " + (err?.message || "desconhecido"));
      setBtnLoading(false);
    }
  }

  async function logout() {
    await clienteSupabase.auth.signOut();
    window.location.reload();
  }

  function mostrarPlayer(user) {
    document.getElementById('login-section').style.display = 'none';
    document.getElementById('nav-login').style.display = 'none';

    document.getElementById('player-section').style.display = 'flex';
    document.getElementById('nav-user').style.display = 'flex';

    const nome = user?.user_metadata?.full_name || 'Cliente';
    document.getElementById('user-name').innerText = "Olá, " + nome.split(' ')[0];
  }

  async function buscarAlertas(userId) {
    try {
      const { data, error } = await clienteSupabase
        .from('alertas_player')
        .select('*')
        .eq('user_id', userId)
        .eq('exibida', false);

      if (error) throw error;

      if (data && data.length > 0) {
        const container = document.getElementById('alert-container');
        container.style.display = 'grid';

        // performance: render 1 vez
        let html = '';
        for (const alerta of data) {
          const classTema =
            alerta.tipo === 'sucesso' ? 'alert-sucesso' :
            (alerta.tipo === 'vencimento' ? 'alert-vencimento' : 'alert-bloqueio');

          const acaoHTML = alerta.link_acao
            ? `<a href="${alerta.link_acao}" target="_blank" class="btn btn--primary" style="margin-top:10px; padding: 8px 16px; min-height:36px; max-width: max-content;">Renovar Agora</a>`
            : '';

          html += `
            <article class="tile col-12 ${classTema}" id="alerta-${alerta.id}">
              <div class="tile__body">
                <div class="tile__title">
                  <span>${alerta.titulo}</span>
                  <span class="close-btn" onclick="marcarAlertaLido('${alerta.id}')">✕</span>
                </div>
                <p class="tile__text">${alerta.mensagem}</p>
                ${acaoHTML}
              </div>
            </article>
          `;
        }
        container.innerHTML = html;
      }
    } catch (err) {
      console.error("Erro ao buscar alertas:", err);
    }
  }

  async function marcarAlertaLido(alertaId) {
    const el = document.getElementById(`alerta-${alertaId}`);
    if (el) el.style.display = 'none';

    const { error } = await clienteSupabase
      .from('alertas_player')
      .update({ exibida: true })
      .eq('id', alertaId);

    if (error) console.error("Erro ao marcar alerta:", error);
  }

  // reatividade: se o usuário logar/deslogar, atualiza UI sem depender só do load
  clienteSupabase.auth.onAuthStateChange((event, session) => {
    if (event === 'SIGNED_IN' && session?.user) {
      mostrarPlayer(session.user);
      buscarAlertas(session.user.id);
    }
    if (event === 'SIGNED_OUT') {
      window.location.reload();
    }
  });

  document.addEventListener("DOMContentLoaded", checarSessao);
</script>