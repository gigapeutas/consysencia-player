<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consysencia - Streaming Premium</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0b0c10;
            color: #ffffff;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .navbar-brand {
            font-weight: 700;
            color: #66fcf1 !important;
            letter-spacing: 1px;
        }
        .hero-section {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2rem;
        }
        .btn-google {
            background-color: #ffffff;
            color: #000000;
            font-weight: 600;
            border-radius: 8px;
            padding: 12px 24px;
            transition: 0.3s;
        }
        .btn-google:hover {
            background-color: #f1f1f1;
            transform: translateY(-2px);
        }
        .alert-box {
            display: none;
            margin-top: 20px;
        }
        .player-container {
            display: none;
            background: #1f2833;
            border-radius: 12px;
            padding: 40px;
            margin-top: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-dark pt-3 pb-3">
        <div class="container">
            <a class="navbar-brand" href="#">CONSYSENCIA</a>
            <div id="user-info" class="d-none">
                <span id="user-name" class="me-3"></span>
                <button onclick="logout()" class="btn btn-sm btn-outline-danger">Sair</button>
            </div>
        </div>
    </nav>

    <div class="container hero-section flex-column">
        
        <div id="alert-container" class="w-100 max-w-md alert-box">
            </div>

        <div id="login-section">
            <h1 class="mb-4 fw-bold">Seu Cinema Particular.</h1>
            <p class="text-muted mb-4">Acesse agora e ganhe 4 horas de pacote completo grátis.</p>
            <button onclick="loginComGoogle()" class="btn btn-google shadow-lg">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" alt="Google" width="20" class="me-2">
                Entrar com Google
            </button>
        </div>

        <div id="player-section" class="player-container w-100">
            <h3 class="fw-bold mb-3 text-info">Bem-vindo de volta!</h3>
            <p>Carregando seu catálogo...</p>
            <p class="text-muted small">Suas credenciais IPTV estão sendo processadas pelo sistema Consysencia.</p>
            </div>
    </div>

    <script>
        // 1. COLOQUE SUAS CHAVES DO SUPABASE AQUI
        // Você pega isso no painel do Supabase em: Settings -> API
        const SUPABASE_URL = 'SUA_URL_DO_SUPABASE_AQUI';
        const SUPABASE_ANON_KEY = 'SUA_ANON_KEY_DO_SUPABASE_AQUI';

        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // 2. Verifica se o usuário já está logado ao abrir a página
        async function checarSessao() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                mostrarPlayer(session.user);
                buscarAlertas(session.user.id);
            }
        }

        // 3. Função de Login Mágico com Google
        async function loginComGoogle() {
            const { data, error } = await supabase.auth.signInWithOAuth({
                provider: 'google',
            });
            if (error) alert("Erro ao fazer login: " + error.message);
        }

        // 4. Função para sair (Logout)
        async function logout() {
            await supabase.auth.signOut();
            window.location.reload();
        }

        // 5. Troca a tela de Login pela tela do Player
        function mostrarPlayer(user) {
            document.getElementById('login-section').classList.add('d-none');
            document.getElementById('player-section').style.display = 'block';
            document.getElementById('user-info').classList.remove('d-none');
            document.getElementById('user-name').innerText = "Olá, " + (user.user_metadata.full_name || 'Cliente');
        }

        // 6. O "Caçador de Alertas" (Substitui o Zap)
        async function buscarAlertas(userId) {
            const { data, error } = await supabase
                .from('alertas_player')
                .select('*')
                .eq('user_id', userId)
                .eq('exibida', false);

            if (data && data.length > 0) {
                const container = document.getElementById('alert-container');
                container.style.display = 'block';
                
                data.forEach(alerta => {
                    // Monta o banner do alerta na tela
                    let cor = alerta.tipo === 'sucesso' ? 'success' : (alerta.tipo === 'vencimento' ? 'warning' : 'info');
                    container.innerHTML += `
                        <div class="alert alert-${cor} alert-dismissible fade show text-start" role="alert">
                            <strong>${alerta.titulo}</strong><br>
                            ${alerta.mensagem}
                            ${alerta.link_acao ? `<br><a href="${alerta.link_acao}" class="btn btn-sm btn-dark mt-2">Renovar Agora</a>` : ''}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" onclick="marcarAlertaLido('${alerta.id}')"></button>
                        </div>
                    `;
                });
            }
        }

        // Marca que o cliente já viu o aviso para não encher a tela dele de novo
        async function marcarAlertaLido(alertaId) {
            await supabase.from('alertas_player').update({ exibida: true }).eq('id', alertaId);
        }

        // Roda a checagem de sessão assim que o site carrega
        checarSessao();
    </script>
</body>
</html>
