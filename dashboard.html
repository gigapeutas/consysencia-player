<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Play Consysencia | VIP</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
    
    :root {
      --bg:#070a0b; --text:#fff; --accent:#00ff88;
      --panelBg:rgba(10,14,15,0.95); --radius:12px;
    }
    body[data-theme="netflix"]{ --bg:#141414; --accent:#E50914; }
    body[data-theme="prime"]{ --bg:#0f171e; --accent:#00A8E1; }
    body[data-theme="disney"]{ --bg:#1a1d29; --accent:#0063e5; }

    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; overflow-x: hidden; }

    #app { display: flex; height: 100vh; width: 100vw; overflow: hidden; position: relative; }
    
    #sidebar { width: 260px; height: 100vh; background: var(--panelBg); padding: 20px 15px; position: absolute; z-index: 100; left: -100%; transition: left 0.3s ease; backdrop-filter: blur(10px); border-right: 1px solid rgba(255,255,255,0.05); }
    #sidebar.open { left: 0; }
    
    .brand { display:flex; align-items:center; gap:10px; padding: 10px; margin-bottom: 20px; font-weight: 900; font-size: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .brand span { color: var(--accent); }

    .navItem { padding: 12px 15px; border-radius: var(--radius); cursor: pointer; display: flex; align-items: center; gap: 12px; font-weight: bold; color: rgba(255,255,255,0.6); margin-bottom: 5px; transition: 0.2s; }
    .navItem.active { background: rgba(255,255,255,0.1); color: var(--accent); }

    #main { flex: 1; height: 100vh; display: flex; flex-direction: column; width: 100vw; }
    
    #topbar { height: 65px; display: flex; align-items: center; padding: 0 15px; gap: 15px; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); z-index: 50; flex-shrink: 0; }
    #hamb { background: none; border: none; color: white; font-size: 24px; padding: 5px; cursor: pointer; }
    #viewTitle { font-weight: 900; font-size: 18px; white-space: nowrap; }
    #search { flex: 1; max-width: 300px; padding: 8px 15px; border-radius: 20px; border: none; background: rgba(255,255,255,0.1); color: white; margin-left: auto; outline: none; }

    #catalogRoot { flex: 1; overflow-y: auto; padding: 10px 15px 40px; -webkit-overflow-scrolling: touch; }
    .row { margin-bottom: 25px; }
    .rowTitle { font-size: 1.1rem; font-weight: 900; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; text-transform: uppercase; }
    .rowTitle::before { content:''; width:4px; height:16px; background: var(--accent); border-radius: 2px; }
    
    .rail { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; scroll-snap-type: x mandatory; }
    .rail::-webkit-scrollbar { display: none; }

    .card { flex: 0 0 auto; width: 130px; height: 195px; border-radius: 8px; background: #111; overflow: hidden; position: relative; scroll-snap-align: start; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); }
    .card.live { width: 180px; height: 100px; }
    .card img { width: 100%; height: 100%; object-fit: cover; background: #222; }
    .cardName { position: absolute; bottom: 0; width: 100%; padding: 15px 8px 5px; background: linear-gradient(transparent, rgba(0,0,0,0.95)); font-size: 11px; text-align: center; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    #loader { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; flex-direction: column; z-index: 2000; color: var(--accent); font-weight: bold; gap: 10px; }
    .spinner { border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--accent); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    #playerRoot { display: none; position: fixed; inset: 0; background: #000; z-index: 9999; flex-direction: column; }
    #pControls { position: absolute; top: 0; width: 100%; padding: 15px; display: flex; align-items: center; gap: 15px; background: linear-gradient(rgba(0,0,0,0.9), transparent); z-index: 10; }
    #btnBack { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 8px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; }
    #video { width: 100%; height: 100%; object-fit: contain; }

    @media (min-width: 900px) {
      #sidebar { left: 0; position: relative; }
      #hamb { display: none; }
      .card { width: 150px; height: 225px; }
      .card.live { width: 220px; height: 124px; }
    }
  </style>
</head>
<body data-theme="consysencia">

<div id="loader"><div class="spinner"></div><div id="lText">Sintonizando Rota VIP...</div></div>

<div id="app">
    <aside id="sidebar">
        <div class="brand"><span>●</span> CONSYSENCIA</div>
        <div class="navItem active" data-tab="live" data-theme="consysencia"><i class="fa-solid fa-tv"></i> TV ao Vivo</div>
        <div class="navItem" data-tab="movies" data-theme="consysencia"><i class="fa-solid fa-film"></i> Catálogo</div>
        <div class="navItem" data-tab="netflix" data-theme="netflix"><i class="fa-brands fa-neos"></i> Netflix</div>
        <div class="navItem" data-tab="prime" data-theme="prime"><i class="fa-brands fa-amazon"></i> Prime Video</div>
        <div class="navItem" data-tab="disney" data-theme="disney"><i class="fa-brands fa-play"></i> Disney+</div>
        <div class="navItem" onclick="localStorage.clear(); location.href='index.html'" style="color:#ff4444; margin-top:20px;"><i class="fa-solid fa-power-off"></i> Reparo Profundo</div>
    </aside>

    <main id="main">
        <div id="topbar">
            <button id="hamb"><i class="fa-solid fa-bars"></i></button>
            <div id="viewTitle">TV ao Vivo</div>
            <input type="text" id="search" placeholder="Buscar..." autocomplete="off">
        </div>
        <div id="catalogRoot"></div>
    </main>
</div>

<div id="playerRoot">
    <div id="pControls">
        <button id="btnBack"><i class="fa-solid fa-arrow-left"></i> Voltar</button>
        <div id="pTitle" style="font-weight: 900; text-shadow: 0 2px 4px black;"></div>
    </div>
    <video id="video" controls autoplay playsinline></video>
</div>

<script>
    const user = localStorage.getItem('cs_user');
    const pass = localStorage.getItem('cs_pass');
    if(!user || !pass) window.location.href = 'index.html';

    const API = 'https://api.consysencia.com/catalog';
    const PROXY_BASE = 'https://api.consysencia.com/proxy';

    let STATE = { live_cat: [], vod_cat: [], live: [], vod: [], tab: 'live' };
    let hls;

    async function fetchData() {
        const h = { 'Authorization': 'Basic ' + btoa(user + ':' + pass) };
        try {
            document.getElementById('lText').innerText = "Liberando Canais...";
            const [lcat, lstr] = await Promise.all([
                fetch(`${API}?action=get_live_categories`, {headers:h}).then(r=>r.json()).catch(()=>[]),
                fetch(`${API}?action=get_live_streams`, {headers:h}).then(r=>r.json()).catch(()=>[])
            ]);
            STATE.live_cat = lcat; STATE.live = lstr;
            
            document.getElementById('loader').style.display = 'none';
            renderTab();

            const [vcat, vstr, scat, sstr] = await Promise.all([
                fetch(`${API}?action=get_vod_categories`, {headers:h}).then(r=>r.json()).catch(()=>[]),
                fetch(`${API}?action=get_vod_streams`, {headers:h}).then(r=>r.json()).catch(()=>[]),
                fetch(`${API}?action=get_series_categories`, {headers:h}).then(r=>r.json()).catch(()=>[]),
                fetch(`${API}?action=get_series`, {headers:h}).then(r=>r.json()).catch(()=>[])
            ]);
            STATE.vod_cat = [...vcat, ...scat];
            STATE.vod = [...vstr, ...sstr];
        } catch(e) {
            alert("Erro de conexão com o servidor central.");
        }
    }

    function renderTab() {
        const root = document.getElementById('catalogRoot');
        root.innerHTML = '';
        
        const isLive = STATE.tab === 'live';
        const cats = isLive ? STATE.live_cat : STATE.vod_cat;
        const items = isLive ? STATE.live : STATE.vod;
        const query = document.getElementById('search').value.toLowerCase();

        cats.forEach(c => {
            if(!isLive && STATE.tab !== 'movies' && !c.category_name.toLowerCase().includes(STATE.tab)) return;

            let catItems = items.filter(i => i.category_id === c.category_id);
            if(query) catItems = catItems.filter(i => i.name.toLowerCase().includes(query));

            if(catItems.length > 0) {
                const row = document.createElement('div');
                row.className = 'row';
                
                // Limite de segurança de memória para não travar o celular
                const safeItems = catItems.slice(0, 30);
                
                row.innerHTML = `
                    <div class="rowTitle">${c.category_name}</div>
                    <div class="rail">
                        ${safeItems.map(i => `
                            <div class="card ${isLive ? 'live' : ''}" onclick="play('${i.stream_id}', '${isLive ? 'live' : (i.series_id ? 'series' : 'movie')}', '${i.container_extension || 'mp4'}', '${i.series_id || ''}', '${i.name.replace(/'/g, "\\'")}')">
                                <img src="${i.stream_icon || i.cover}" loading="lazy" onerror="this.style.display='none'">
                                <div class="cardName">${i.name}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                root.appendChild(row);
            }
        });
    }

    async function play(id, type, ext, series_id, name) {
        document.getElementById('pTitle').innerText = name;
        
        if (type === 'series') {
            document.getElementById('loader').style.display = 'flex';
            document.getElementById('lText').innerText = "Abrindo Episódio...";
            try {
                const res = await fetch(`${API}?action=get_series_info&series_id=${series_id}`, { headers: { 'Authorization': 'Basic ' + btoa(user + ':' + pass) } });
                const data = await res.json();
                document.getElementById('loader').style.display = 'none';
                
                let epObj = data.episodes;
                let seasons = Array.isArray(epObj) ? epObj : Object.values(epObj);
                if(seasons.length > 0 && seasons[0].length > 0) {
                    id = seasons[0][0].id;
                    ext = seasons[0][0].container_extension || 'mp4';
                } else {
                    return alert("Série vazia.");
                }
            } catch(e) {
                document.getElementById('loader').style.display = 'none';
                return alert("Falha ao abrir série.");
            }
        }

        // Constrói a URL Segura que passa pelo Render
        const secureUrl = `${PROXY_BASE}/${type}/${user}/${pass}/${id}.${type==='live'?'m3u8':ext}`;

        document.getElementById('app').style.display = 'none';
        document.getElementById('playerRoot').style.display = 'flex';
        const video = document.getElementById('video');

        if(hls) { hls.destroy(); hls = null; }

        if(type === 'live' && Hls.isSupported()) {
            hls = new Hls({
                // RASTREADOR: Captura os pedacinhos soltos da TV e obriga a passar pelo Render
                xhrSetup: function(xhr, url) {
                    if (url.startsWith('http') && !url.includes('api.consysencia.com')) {
                        try {
                            const urlObj = new URL(url);
                            url = PROXY_BASE + urlObj.pathname + urlObj.search;
                        } catch(e) {}
                    }
                    xhr.open('GET', url, true);
                }
            });
            hls.loadSource(secureUrl);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => video.play().catch(()=>{}));
            
            // Tratamento de Erros da TV ao Vivo
            hls.on(Hls.Events.ERROR, function (event, data) {
                if (data.fatal) {
                    switch (data.type) {
                        case Hls.ErrorTypes.NETWORK_ERROR:
                            console.log("Tentando reconectar a TV...");
                            hls.startLoad();
                            break;
                        default:
                            hls.destroy();
                            break;
                    }
                }
            });
        } else {
            video.src = secureUrl;
            video.play().catch(()=>{});
        }
    }

    document.getElementById('btnBack').onclick = () => {
        const video = document.getElementById('video');
        video.pause(); video.src = "";
        if(hls) hls.destroy();
        document.getElementById('playerRoot').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
    };

    document.getElementById('hamb').onclick = () => document.getElementById('sidebar').classList.toggle('open');
    
    document.querySelectorAll('.navItem[data-tab]').forEach(el => {
        el.onclick = () => {
            document.querySelectorAll('.navItem').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
            STATE.tab = el.dataset.tab;
            document.body.dataset.theme = el.dataset.theme;
            document.getElementById('viewTitle').innerText = el.innerText;
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('search').value = '';
            renderTab();
        };
    });

    let tOut;
    document.getElementById('search').oninput = () => {
        clearTimeout(tOut);
        tOut = setTimeout(renderTab, 300);
    };

    fetchData();
</script>
</body>
</html>
