<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Play Consysencia | Pena</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        :root { --bg: #070a0b; --neon: #00ff88; --card-w: 150px; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: white; font-family: 'Inter', sans-serif; overflow-x: hidden; }

        /* BARRA LATERAL RESPONSIVA */
        .sidebar { position: fixed; left: -280px; top: 0; width: 280px; height: 100vh; background: rgba(0,0,0,0.95); z-index: 2000; transition: 0.3s; padding: 40px 20px; backdrop-filter: blur(10px); border-right: 1px solid rgba(0,255,136,0.2); }
        .sidebar.open { left: 0; }
        .menu-item { padding: 15px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 15px; color: #888; transition: 0.2s; }
        .menu-item:hover, .menu-item.active { background: rgba(0,255,136,0.1); color: var(--neon); }

        /* INTERFACE PRINCIPAL */
        #main-view { padding: 20px; transition: 0.3s; }
        .header { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; margin-top: 40px; }
        .btn-menu { font-size: 24px; cursor: pointer; color: var(--neon); }
        
        /* GRID DE CAPAS (LEVE) */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; }
        .card { background: #111; border-radius: 8px; overflow: hidden; position: relative; aspect-ratio: 2/3; cursor: pointer; border: 2px solid transparent; transition: 0.3s; }
        .card.live { aspect-ratio: 16/9; }
        .card:hover { border-color: var(--neon); transform: scale(1.03); }
        .card img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .card-name { position: absolute; bottom: 0; width: 100%; padding: 10px; background: linear-gradient(transparent, black); font-size: 11px; text-align: center; font-weight: bold; }

        /* PLAYER "PENA" (OCUPA TUDO E APAGA O RESTO) */
        #player-view { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 3000; flex-direction: column; }
        .player-controls { position: absolute; top: 0; width: 100%; padding: 20px; display: flex; justify-content: space-between; z-index: 10; background: linear-gradient(rgba(0,0,0,0.8), transparent); }
        video { width: 100%; height: 100%; object-fit: contain; }
        .btn-back { background: var(--neon); color: black; padding: 10px 20px; border-radius: 5px; font-weight: 900; border: none; cursor: pointer; }

        .loader { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 5000; font-weight: bold; color: var(--neon); }
    </style>
</head>
<body>

<div id="loader" class="loader">Sincronizando...</div>

<div class="sidebar" id="sidebar">
    <h2 style="color:var(--neon); margin-bottom:30px;">PLAY CONSYSENCIA</h2>
    <div class="menu-item active" onclick="loadContent('live')"><i class="fa-solid fa-tv"></i> TV ao Vivo</div>
    <div class="menu-item" onclick="loadContent('netflix')"><i class="fa-brands fa-neos"></i> Netflix</div>
    <div class="menu-item" onclick="loadContent('prime')"><i class="fa-brands fa-amazon"></i> Prime Video</div>
    <div class="menu-item" onclick="loadContent('disney')"><i class="fa-brands fa-play"></i> Disney+</div>
    <div class="menu-item" style="margin-top:20px; color:#ff4444;" onclick="localStorage.clear(); location.href='index.html'"><i class="fa-solid fa-power-off"></i> Sair</div>
</div>

<div id="main-view">
    <div class="header">
        <div class="btn-menu" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></div>
        <h1 id="page-title" style="font-size: 20px;">TV ao Vivo</h1>
    </div>
    <div class="grid" id="content-grid"></div>
</div>

<div id="player-view">
    <div class="player-controls">
        <button class="btn-back" onclick="closePlayer()"><i class="fa-solid fa-arrow-left"></i> VOLTAR</button>
        <div id="playing-title" style="font-weight: bold; text-shadow: 2px 2px black;"></div>
    </div>
    <video id="video" controls autoplay playsinline></video>
</div>

<script>
    const user = localStorage.getItem('cs_user');
    const pass = localStorage.getItem('cs_pass');
    const api = 'https://api.consysencia.com/catalog';
    const streamServer = 'http://ph1233.uk';

    let DB = { live: [], vod: [], live_cat: [], vod_cat: [] };

    async function start() {
        if(!user) return location.href = 'index.html';
        try {
            const h = { 'Authorization': 'Basic ' + btoa(user + ':' + pass) };
            const [lcat, lstr, vcat, vstr] = await Promise.all([
                fetch(`${api}?action=get_live_categories`, {headers:h}).then(r=>r.json()),
                fetch(`${api}?action=get_live_streams`, {headers:h}).then(r=>r.json()),
                fetch(`${api}?action=get_vod_categories`, {headers:h}).then(r=>r.json()),
                fetch(`${api}?action=get_vod_streams`, {headers:h}).then(r=>r.json())
            ]);
            DB = { live: lstr, vod: vstr, live_cat: lcat, vod_cat: vcat };
            document.getElementById('loader').style.display = 'none';
            loadContent('live');
        } catch(e) { alert("Erro de conexão."); }
    }

    function toggleMenu() { document.getElementById('sidebar').classList.toggle('open'); }

    function loadContent(type) {
        toggleMenu();
        const grid = document.getElementById('content-grid');
        const title = document.getElementById('page-title');
        grid.innerHTML = ''; 
        
        let items = [];
        if(type === 'live') {
            title.innerText = "Canais ao Vivo";
            items = DB.live.slice(0, 300); // Limite para fluidez
        } else {
            title.innerText = type.toUpperCase();
            // Filtro inteligente para pegar categorias que contêm o nome da plataforma
            const validCats = DB.vod_cat.filter(c => c.category_name.toLowerCase().includes(type)).map(c => c.category_id);
            items = DB.vod.filter(v => validCats.includes(v.category_id));
        }

        grid.innerHTML = items.map(item => `
            <div class="card ${type === 'live' ? 'live' : 'vod'}" onclick="play('${item.stream_id}', '${item.name.replace(/'/g, "")}', '${type}')">
                <img src="${item.stream_icon}" loading="lazy" onerror="this.src='https://placehold.co/400x600/111/fff?text=Play'">
                <div class="card-name">${item.name}</div>
            </div>
        `).join('');
    }

    let hls;
    function play(id, name, type) {
        document.getElementById('main-view').style.display = 'none';
        document.getElementById('player-view').style.display = 'flex';
        document.getElementById('playing-title').innerText = name;
        
        const video = document.getElementById('video');
        const url = type === 'live' ? `${streamServer}/live/${user}/${pass}/${id}.m3u8` : `${streamServer}/movie/${user}/${pass}/${id}.mp4`;

        if(type === 'live' && Hls.isSupported()) {
            if(hls) hls.destroy();
            hls = new Hls();
            hls.loadSource(url);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
        } else {
            video.src = url;
            video.play();
        }
    }

    function closePlayer() {
        const video = document.getElementById('video');
        video.pause(); video.src = "";
        if(hls) hls.destroy();
        document.getElementById('player-view').style.display = 'none';
        document.getElementById('main-view').style.display = 'block';
    }

    start();
</script>
</body>
</html>
