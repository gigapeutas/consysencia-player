<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Play Consysencia | V8 Absoluta</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap');

    :root{
      --bg:#070a0b; --bg2:#0b0f10; --text:#fff;
      --accent:#00ff88; --accent2:rgba(0,255,136,.18);
      --radius:12px; --radius2:16px;
      --shadow1:0 10px 22px rgba(0,0,0,.35);
      --navGrad:linear-gradient(to bottom, rgba(0,0,0,.92), rgba(0,0,0,.45), transparent);
      --panelBg:rgba(0,0,0,.92);
      --btnBg:rgba(255,255,255,.06); --btnBd:rgba(255,255,255,.14);
      --cardBd:rgba(255,255,255,.10);
      --brandFont: "Inter", sans-serif;
    }

    body[data-theme="consysencia"]{ --accent:#00ff88; --bg:#070a0b; }
    body[data-theme="netflix"]{ --accent:#E50914; --bg:#141414; --brandFont:"Bebas Neue", sans-serif; }
    body[data-theme="prime"]{ --accent:#00A8E1; --bg:#0f171e; }
    body[data-theme="disney"]{ --accent:#0063e5; --bg:#1a1d29; }
    body[data-theme="hbomax"]{ --accent:#8b5cf6; --bg:#0b0616; }
    body[data-theme="globoplay"]{ --accent:#ff3d00; --bg:#0b0b0f; }

    *{ margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    body{ background: var(--bg); color: var(--text); font-family: "Inter", sans-serif; overflow: hidden; transition: 0.3s ease; }
    
    #app{ height:100vh; width:100vw; display:flex; }

    /* SIDEBAR */
    #sidebar{ width: 280px; background: var(--panelBg); border-right: 1px solid rgba(255,255,255,.10); padding: 22px 14px; position: relative; transition: 0.3s; z-index: 30; }
    #sidebar .brand{ display:flex; align-items:center; gap:10px; padding: 8px 10px 16px; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,.08); }
    #sidebar .brand h1{ font-size: 24px; font-weight: 900; }
    body[data-theme="netflix"] #sidebar .brand h1{ font-family: var(--brandFont); font-size: 32px; letter-spacing: 1.5px; }

    .navItem{ display:flex; align-items:center; gap:12px; padding: 12px; border-radius: var(--radius); cursor:pointer; color: rgba(255,255,255,.70); font-weight: 800; margin-bottom: 6px; transition: 0.2s;}
    .navItem:hover{ background: rgba(255,255,255,.06); color: #fff; transform: translateX(2px); }
    .navItem.active{ background: rgba(255,255,255,.08); color: var(--accent); }

    /* MAIN & TOPBAR */
    #main{ flex:1; position: relative; }
    #topbar{ position: absolute; top:0; left:0; right:0; height: 74px; display:flex; align-items:center; gap: 14px; padding: 0 18px; background: var(--navGrad); z-index: 20; backdrop-filter: blur(12px); }
    #hamb{ display:none; width: 44px; height: 44px; border-radius: 12px; background: rgba(255,255,255,.05); border:none; color: #fff; cursor:pointer; }
    #viewTitle{ font-weight: 900; font-size: 18px; text-shadow: 0 2px 14px rgba(0,0,0,.45); }
    body[data-theme="netflix"] #viewTitle{ font-family: var(--brandFont); font-size: 28px; letter-spacing: 1.2px; }

    #searchWrap{ margin-left:auto; display:flex; align-items:center; gap: 10px; width: 50%; max-width: 400px; height: 44px; padding: 0 15px; border-radius: 14px; background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.12); }
    #searchWrap input{ flex:1; background: transparent; border: none; color:#fff; font-weight: 800; outline:none; }

    /* CATALOGO TRILHAS */
    #catalogRoot{ position:absolute; inset:0; overflow-y: auto; padding-top: 86px; padding-bottom: 30px; scroll-behavior: smooth; }
    .row{ padding: 12px 18px 8px; }
    .rowTitle{ font-weight: 900; margin-bottom: 12px; color: #fff; display: flex; align-items: center; gap: 8px; text-shadow: 0 2px 12px rgba(0,0,0,.45); }
    .rowTitle i { color: var(--accent); font-size: 10px; }
    .rail{ display:flex; gap: 12px; overflow-x: auto; padding-bottom: 15px; scroll-snap-type: x mandatory; }
    .rail::-webkit-scrollbar{ display: none; }

    /* CARDS */
    .card{ flex: 0 0 auto; width: 140px; aspect-ratio: 2/3; border-radius: var(--radius); background: #111; border: 1px solid var(--cardBd); position: relative; cursor: pointer; transition: 0.2s; overflow: hidden; }
    .card.live{ width: 220px; aspect-ratio: 16/9; }
    .card:hover{ transform: translateY(-4px) scale(1.05); border-color: var(--accent); box-shadow: var(--shadow1); z-index: 2; }
    .card img{ width: 100%; height: 100%; object-fit: cover; }
    .meta{ position:absolute; bottom:0; width:100%; padding: 25px 10px 10px; background: linear-gradient(to top, rgba(0,0,0,.95), transparent); text-align: center; font-size: 11px; font-weight: 900; }

    /* PLAYER UNMOUNT */
    #playerRoot{ display:none; position: fixed; inset:0; background: #000; z-index: 9000; flex-direction: column;}
    #pControls{ position:absolute; top:0; width:100%; height: 74px; display:flex; align-items:center; gap: 15px; padding: 0 18px; background: linear-gradient(rgba(0,0,0,.92), transparent); z-index: 10; }
    #btnBack{ padding: 10px 20px; border-radius: var(--radius); background: var(--btnBg); color:#fff; font-weight: 900; border: 1px solid var(--btnBd); cursor:pointer; transition: 0.2s;}
    #btnBack:hover{ background: var(--accent); color: #000; border-color: var(--accent); }
    #pTitle{ font-weight: 900; }
    #video{ width:100%; height:100%; object-fit: contain; background:#000; outline: none; }

    /* LOADER */
    #loader{ position: fixed; inset: 0; display:flex; align-items:center; justify-content:center; flex-direction: column; gap: 14px; background: #070a0b; z-index: 9999; color: var(--accent); font-weight: 900; }
    .spinner{ width: 40px; height: 40px; border: 4px solid rgba(255,255,255,.10); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    @media (max-width: 900px){
      #hamb{ display:block; }
      #sidebar{ position: absolute; left: -100%; height: 100%; }
      #sidebar.open{ left: 0; }
    }
  </style>
</head>

<body data-theme="consysencia">
  <div id="loader"><div class="spinner"></div><div id="loaderText">Sincronizando Multiverso...</div></div>

  <div id="app">
    <aside id="sidebar">
      <div class="brand"><h1>CONSYSENCIA</h1></div>
      <div class="navItem active" data-tab="live" data-theme="consysencia"><i class="fa-solid fa-tv"></i> TV ao Vivo</div>
      <div class="navItem" data-tab="movies" data-theme="consysencia"><i class="fa-solid fa-film"></i> Todo o Catálogo</div>
      <div style="height:15px"></div>
      <div class="navItem" data-tab="netflix" data-theme="netflix"><i class="fa-brands fa-neos"></i> Netflix</div>
      <div class="navItem" data-tab="disney" data-theme="disney"><i class="fa-brands fa-play"></i> Disney+</div>
      <div class="navItem" data-tab="prime" data-theme="prime"><i class="fa-brands fa-amazon"></i> Prime Video</div>
      <div class="navItem" data-tab="hbomax" data-theme="hbomax"><i class="fa-solid fa-m"></i> HBO Max</div>
      <div class="navItem" data-tab="globoplay" data-theme="globoplay"><i class="fa-solid fa-g"></i> GloboPlay</div>
      <div style="height:20px"></div>
      <div class="navItem" id="btnClear" style="color:#ff4444"><i class="fa-solid fa-power-off"></i> Reparar Erros (Limpar)</div>
    </aside>

    <main id="main">
      <div id="topbar">
        <button id="hamb"><i class="fa-solid fa-bars"></i></button>
        <div id="viewTitle">TV ao Vivo</div>
        <div id="searchWrap">
          <i class="fa-solid fa-magnifying-glass"></i>
          <input id="search" placeholder="Buscar filmes e canais..." autocomplete="off" />
        </div>
      </div>
      <div id="catalogRoot"></div>
    </main>
  </div>

  <div id="playerRoot">
    <div id="pControls">
      <button id="btnBack"><i class="fa-solid fa-arrow-left"></i> Voltar</button>
      <div id="pTitle"></div>
    </div>
    <video id="video" controls autoplay playsinline></video>
  </div>

  <script>
    (function(){
      'use strict';

      // CREDENCIAIS
      const user = localStorage.getItem('cs_user');
      const pass = localStorage.getItem('cs_pass');
      if(!user || !pass) window.location.href = 'index.html';

      const apiBase = 'https://api.consysencia.com/catalog';
      
      // O SEGREDO DO FAILOVER (TENTA HTTPS PRIMEIRO PARA DRIBLAR O BLOQUEIO)
      const STREAM_SERVERS = [
        'https://playtvstreaming.shop', // Tenta seguro
        'https://ph1233.uk',
        'http://playtvstreaming.shop',  // Tenta inseguro se falhar
        'http://ph1233.uk'
      ];

      const STATE = {
        tab: 'live', query: '', mounted: true, hls: null,
        live_cat: [], vod_cat: [], live_streams: [], vod_streams: [],
        liveByCat: new Map(), vodByCat: new Map(),
        failoverIdx: 0, currentPlayData: null
      };

      // Fura Emojis e Símbolos
      function normKey(s){
        if(!s) return '';
        return (''+s).normalize('NFKD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/[^a-z0-9]+/g,'');
      }

      // INDEXED DB - CACHE DE ALTA VELOCIDADE
      function idbOpen(){
        return new Promise((res, rej)=>{
          const req = indexedDB.open('consysencia_v8', 1);
          req.onupgradeneeded = e => { if(!req.result.objectStoreNames.contains('cache')) req.result.createObjectStore('cache'); };
          req.onsuccess = ()=> res(req.result);
          req.onerror = ()=> rej(req.error);
        });
      }
      function idbGet(db, key){
        return new Promise(res => { db.transaction('cache', 'readonly').objectStore('cache').get(key).onsuccess = e => res(e.target.result); });
      }
      function idbSet(db, key, val){
        return new Promise(res => { db.transaction('cache', 'readwrite').objectStore('cache').put(val, key).oncomplete = ()=> res(true); });
      }

      // PUXA TUDO (FILMES + SÉRIES UNIDOS)
      async function fetchData(){
        document.getElementById('loaderText').innerText = "Baixando Filmes e Séries (Pode levar 20s)...";
        const h = { 'Authorization': 'Basic ' + btoa(user + ':' + pass) };
        
        // Puxa as 6 listas do Xtream Codes!
        const [lc, ls, vc, vs, sc, ss] = await Promise.all([
          fetch(`${apiBase}?action=get_live_categories`, {headers:h}).then(r=>r.json()).catch(()=>[]),
          fetch(`${apiBase}?action=get_live_streams`, {headers:h}).then(r=>r.json()).catch(()=>[]),
          fetch(`${apiBase}?action=get_vod_categories`, {headers:h}).then(r=>r.json()).catch(()=>[]),
          fetch(`${apiBase}?action=get_vod_streams`, {headers:h}).then(r=>r.json()).catch(()=>[]),
          fetch(`${apiBase}?action=get_series_categories`, {headers:h}).then(r=>r.json()).catch(()=>[]),
          fetch(`${apiBase}?action=get_series`, {headers:h}).then(r=>r.json()).catch(()=>[])
        ]);

        // Funde Filmes e Séries para a aba Netflix funcionar perfeitamente
        return {
          live_cat: lc || [], live_streams: ls || [],
          vod_cat: [...(vc||[]), ...(sc||[])],
          vod_streams: [...(vs||[]), ...(ss||[])]
        };
      }

      function buildIndexes(){
        STATE.liveByCat = new Map(); STATE.vodByCat = new Map();
        STATE.live_streams.forEach(it => { const k=''+it.category_id; STATE.liveByCat.set(k, (STATE.liveByCat.get(k)||[]).concat(it)); });
        STATE.vod_streams.forEach(it => { const k=''+it.category_id; STATE.vodByCat.set(k, (STATE.vodByCat.get(k)||[]).concat(it)); });
      }

      function renderTab(){
        const root = document.getElementById('catalogRoot');
        root.innerHTML = '';
        const cats = STATE.tab === 'live' ? STATE.live_cat : STATE.vod_cat;
        const map = STATE.tab === 'live' ? STATE.liveByCat : STATE.vodByCat;
        const q = normKey(STATE.query);

        cats.forEach(c => {
          // Filtro Plataforma
          if(STATE.tab !== 'live' && STATE.tab !== 'movies'){
            const t = STATE.tab === 'hbomax' ? 'hbo' : (STATE.tab === 'globoplay' ? 'globo' : STATE.tab);
            if(normKey(c.category_name).indexOf(t) === -1) return;
          }

          let items = map.get(''+c.category_id) || [];
          if(q) items = items.filter(it => normKey(it.name).includes(q));

          if(items.length > 0){
            const row = document.createElement('div'); row.className = 'row';
            row.innerHTML = `<div class="rowTitle"><i class="fa-solid fa-play"></i> ${c.category_name}</div><div class="rail"></div>`;
            const rail = row.querySelector('.rail');
            
            // Renderiza limitando a 100 por trilha para não travar a TV
            items.slice(0, 100).forEach(it => {
              const card = document.createElement('div');
              card.className = `card ${STATE.tab === 'live' ? 'live' : 'vod'}`;
              card.innerHTML = `<img src="${it.stream_icon||it.cover||''}" loading="lazy"><div class="meta">${it.name}</div>`;
              card.onclick = () => handlePlayClick(it, STATE.tab === 'live' ? 'live' : (it.series_id ? 'series' : 'movie'));
              rail.appendChild(card);
            });
            root.appendChild(row);
          }
        });
      }

      // LIDA COM CLIQUES (SE FOR SÉRIE, PEGA EPISÓDIO 1)
      async function handlePlayClick(item, type) {
        if(type === 'series') {
            document.getElementById('loader').style.display = 'flex';
            document.getElementById('loaderText').innerText = "Buscando Episódio 1...";
            try {
                const res = await fetch(`${apiBase}?action=get_series_info&series_id=${item.series_id}`, {headers:{ 'Authorization': 'Basic ' + btoa(user + ':' + pass) }});
                const data = await res.json();
                document.getElementById('loader').style.display = 'none';
                
                // Tenta pegar a temporada 1, ep 1
                const seasons = Object.values(data.episodes);
                if(seasons.length > 0 && seasons[0].length > 0) {
                    const ep = seasons[0][0];
                    startPlayback(ep.id, `S01E01 - ${ep.title}`, 'movie', ep.container_extension || 'mp4');
                } else { alert("Nenhum episódio encontrado no servidor."); }
            } catch(e) { document.getElementById('loader').style.display = 'none'; alert("Erro ao carregar episódios."); }
        } else {
            startPlayback(item.stream_id, item.name, type, item.container_extension || 'mp4');
        }
      }

      // O MOTOR DE VÍDEO BLINDADO COM FAILOVER
      function startPlayback(id, name, type, ext) {
          STATE.failoverIdx = 0;
          STATE.currentPlayData = { id, name, type, ext };
          
          document.getElementById('catalogRoot').style.display = 'none';
          document.getElementById('playerRoot').style.display = 'flex';
          document.getElementById('pTitle').innerText = name;
          
          tryServer();
      }

      function tryServer() {
          const video = document.getElementById('video');
          if (STATE.failoverIdx >= STREAM_SERVERS.length) {
              alert("O Navegador bloqueou o vídeo (Segurança HTTPS) ou o canal está fora do ar.");
              document.getElementById('btnBack').click();
              return;
          }

          const serverBase = STREAM_SERVERS[STATE.failoverIdx++];
          const { id, type, ext } = STATE.currentPlayData;
          const url = type === 'live' 
            ? `${serverBase}/live/${user}/${pass}/${id}.m3u8`
            : `${serverBase}/movie/${user}/${pass}/${id}.${ext}`;

          if(STATE.hls) { STATE.hls.destroy(); STATE.hls = null; }

          if (type === 'live' && Hls.isSupported()) {
              STATE.hls = new Hls();
              STATE.hls.loadSource(url);
              STATE.hls.attachMedia(video);
              STATE.hls.on(Hls.Events.ERROR, (e, data) => {
                  if (data.fatal) tryServer(); // Se der tela preta, tenta o próximo servidor!
              });
              STATE.hls.on(Hls.Events.MANIFEST_PARSED, () => video.play().catch(()=>{}));
          } else {
              video.src = url;
              video.play().catch(()=>{});
              video.onerror = () => tryServer(); // Se o MP4 falhar, tenta o próximo!
          }
      }

      document.getElementById('btnBack').onclick = () => {
          const video = document.getElementById('video');
          video.pause(); video.src = "";
          if(STATE.hls) { STATE.hls.destroy(); STATE.hls = null; }
          document.getElementById('playerRoot').style.display = 'none';
          document.getElementById('catalogRoot').style.display = 'block';
      };

      // EVENTOS DE MENU
      document.getElementById('hamb').onclick = ()=> document.getElementById('sidebar').classList.toggle('open');
      document.querySelectorAll('.navItem[data-tab]').forEach(el => {
        el.onclick = () => {
          document.querySelectorAll('.navItem').forEach(n => n.classList.remove('active'));
          el.classList.add('active');
          document.body.dataset.theme = el.dataset.theme;
          STATE.tab = el.dataset.tab;
          document.getElementById('sidebar').classList.remove('open');
          renderTab();
        };
      });
      document.getElementById('search').oninput = e => {
          STATE.query = e.target.value;
          clearTimeout(STATE.tSearch);
          STATE.tSearch = setTimeout(renderTab, 300);
      };
      document.getElementById('btnClear').onclick = async () => {
          indexedDB.deleteDatabase('consysencia_v8');
          localStorage.clear(); location.href = 'index.html';
      };

      // BOOT DE INICIALIZAÇÃO
      async function boot(){
        try {
            let db = await idbOpen();
            const cached = await idbGet(db, 'data');
            if(cached && cached.live_cat && cached.live_cat.length > 0){
                Object.assign(STATE, cached);
            } else {
                const fresh = await fetchData();
                Object.assign(STATE, fresh);
                await idbSet(db, 'data', fresh);
            }
            db.close();
            buildIndexes();
            document.getElementById('loader').style.display = 'none';
            renderTab();
        } catch(e) {
            document.getElementById('loaderText').innerText = "Erro Crítico. Clique em Reparar Erros.";
        }
      }
      boot();
    })();
  </script>
</body>
</html>
