<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Consysencia | TV ao Vivo</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
    :root { --bg: #0b0f10; --bg2: #151a1c; --text: #fff; --accent: #00ff88; --radius: 10px; }
    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; height: 100vh; display: flex; overflow: hidden; }

    /* LAYOUT: Barra lateral e Conteúdo */
    #sidebar { width: 280px; background: var(--bg2); border-right: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; z-index: 50; transition: 0.3s; }
    .brand { padding: 20px; font-weight: 900; font-size: 1.2rem; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; gap: 10px; }
    .brand i { color: var(--accent); cursor: pointer; }
    
    #catList { flex: 1; overflow-y: auto; padding: 10px; }
    #catList::-webkit-scrollbar { display: none; }
    .cat-item { padding: 12px 15px; border-radius: var(--radius); cursor: pointer; font-weight: 600; color: rgba(255,255,255,0.6); margin-bottom: 4px; font-size: 0.9rem; transition: 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .cat-item:hover, .cat-item.active { background: rgba(255,255,255,0.08); color: #fff; border-left: 3px solid var(--accent); }

    #main { flex: 1; display: flex; flex-direction: column; position: relative; }
    
    /* TOPO COM BUSCA */
    #topbar { height: 65px; display: flex; align-items: center; padding: 0 20px; border-bottom: 1px solid rgba(255,255,255,0.05); gap: 15px; }
    #btnMenu { background: none; border: none; color: white; font-size: 1.5rem; display: none; }
    #catTitle { font-weight: 900; font-size: 1.1rem; flex: 1; text-transform: uppercase; }
    #search { max-width: 200px; padding: 8px 15px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.5); color: white; outline: none; }

    /* PLAYER DE VÍDEO (Fixo no topo quando ativo) */
    #playerContainer { display: none; width: 100%; background: #000; position: relative; aspect-ratio: 16/9; max-height: 40vh; flex-shrink: 0; }
    #video { width: 100%; height: 100%; object-fit: contain; }
    #closePlayer { position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 8px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; z-index: 10; backdrop-filter: blur(5px); }

    /* GRID DE CANAIS */
    #channelGrid { flex: 1; overflow-y: auto; padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; align-content: start; }
    .channel-card { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.08); border-radius: var(--radius); padding: 15px 10px; text-align: center; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; aspect-ratio: 1; }
    .channel-card:hover { border-color: var(--accent); background: rgba(255,255,255,0.05); transform: translateY(-3px); }
    .channel-card img { width: 60px; height: 60px; object-fit: contain; }
    .channel-card span { font-size: 0.85rem; font-weight: bold; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

    #loader { position: fixed; inset: 0; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: var(--accent); font-weight: 900; }
    .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 900px) {
      #sidebar { position: absolute; left: -100%; height: 100%; }
      #sidebar.open { left: 0; }
      #btnMenu { display: block; }
      #playerContainer { max-height: 35vh; }
      #channelGrid { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; padding: 15px; }
    }
  </style>
</head>
<body>

<div id="loader"><div class="spinner"></div><div>Sintonizando Servidor...</div></div>

<div id="app">
    <aside id="sidebar">
        <div class="brand"><i class="fa-solid fa-arrow-left" onclick="window.location.href='index.html'"></i> TV AO VIVO</div>
        <div id="catList"></div>
    </aside>

    <main id="main">
        <div id="topbar">
            <button id="btnMenu" onclick="document.getElementById('sidebar').classList.toggle('open')"><i class="fa-solid fa-bars"></i></button>
            <div id="catTitle">Todas as Categorias</div>
            <input type="text" id="search" placeholder="Buscar canal..." autocomplete="off">
        </div>
        
        <div id="playerContainer">
            <button id="closePlayer" onclick="stopPlayer()"><i class="fa-solid fa-xmark"></i> Fechar</button>
            <video id="video" controls autoplay playsinline></video>
        </div>

        <div id="channelGrid"></div>
    </main>
</div>

<script>
    const u = new URLSearchParams(window.location.search).get('u');
    const p = new URLSearchParams(window.location.search).get('p');
    if(!u || !p) window.location.href = 'index.html';

    const API = 'https://api.consysencia.com/catalog';
    const PROXY_BASE = 'https://api.consysencia.com/proxy';
    const h = { 'Authorization': 'Basic ' + btoa(u + ':' + p) };

    let categories = [];
    let channels = [];
    let activeCat = '';
    let hls = null;

    async function bootLive() {
        try {
            const [cRes, sRes] = await Promise.all([
                fetch(`${API}?action=get_live_categories`, {headers:h}).then(r=>r.json()),
                fetch(`${API}?action=get_live_streams`, {headers:h}).then(r=>r.json())
            ]);
            categories = cRes || [];
            channels = sRes || [];
            
            renderCategories();
            renderChannels();
            document.getElementById('loader').style.display = 'none';
        } catch(e) {
            alert("Falha ao carregar canais.");
            window.location.href = 'index.html';
        }
    }

    function renderCategories() {
        const list = document.getElementById('catList');
        let html = `<div class="cat-item active" onclick="selectCategory('', 'Todos os Canais')">Todos os Canais</div>`;
        categories.forEach(c => {
            html += `<div class="cat-item" onclick="selectCategory('${c.category_id}', '${c.category_name}')">${c.category_name}</div>`;
        });
        list.innerHTML = html;
    }

    function selectCategory(id, name) {
        activeCat = id;
        document.getElementById('catTitle').innerText = name;
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('search').value = '';
        
        // Atualiza a cor visual do menu
        const items = document.querySelectorAll('.cat-item');
        items.forEach(el => {
            if(el.innerText === name) el.classList.add('active');
            else el.classList.remove('active');
        });
        
        renderChannels();
    }

    function renderChannels() {
        const grid = document.getElementById('channelGrid');
        const q = document.getElementById('search').value.toLowerCase();
        
        let filtered = channels;
        if(activeCat) filtered = filtered.filter(c => c.category_id == activeCat);
        if(q) filtered = filtered.filter(c => c.name.toLowerCase().includes(q));

        // Limite de segurança de renderização
        grid.innerHTML = filtered.slice(0, 150).map(c => {
            const img = c.stream_icon || 'https://via.placeholder.com/60x60/111/fff?text=TV';
            const safeName = c.name.replace(/'/g, "\\'");
            return `
            <div class="channel-card" onclick="playChannel('${c.stream_id}')">
                <img src="${img}" loading="lazy" onerror="this.src='https://via.placeholder.com/60x60/111/fff?text=TV'">
                <span>${c.name}</span>
            </div>`;
        }).join('');
    }

    // A SOLUÇÃO DEFINITIVA DO HLS (Sua pesquisa aplicada)
    function playChannel(id) {
        const video = document.getElementById('video');
        const container = document.getElementById('playerContainer');
        const url = `${PROXY_BASE}/live/${u}/${p}/${id}.m3u8`;

        container.style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });

        if (hls) { hls.destroy(); hls = null; }

        if (Hls.isSupported()) {
            hls = new Hls({
                // O Interceptador Anti-CORS! Se o canal mandar baixar .ts via HTTP, nós jogamos pro Render.
                xhrSetup: function(xhr, fragUrl) {
                    if (fragUrl.startsWith('http://') && !fragUrl.includes('api.consysencia.com')) {
                        try {
                            const uObj = new URL(fragUrl);
                            fragUrl = PROXY_BASE + uObj.pathname + uObj.search;
                        } catch(e) {}
                    }
                    xhr.open('GET', fragUrl, true);
                }
            });
            hls.loadSource(url);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => video.play().catch(()=>{}));
            
            // Tratamento de travamento: tenta reconectar automaticamente
            hls.on(Hls.Events.ERROR, function (event, data) {
                if (data.fatal && data.type === Hls.ErrorTypes.NETWORK_ERROR) {
                    console.log("Queda na rede. Reconectando...");
                    hls.startLoad();
                }
            });
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = url;
            video.play().catch(()=>{});
        }
    }

    function stopPlayer() {
        if(hls) { hls.destroy(); hls = null; }
        const video = document.getElementById('video');
        video.pause(); video.src = '';
        document.getElementById('playerContainer').style.display = 'none';
    }

    document.getElementById('search').oninput = () => setTimeout(renderChannels, 300);

    bootLive();
</script>
</body>
</html>
